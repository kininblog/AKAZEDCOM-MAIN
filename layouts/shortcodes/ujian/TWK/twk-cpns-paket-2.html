
    <!-- SELURUH KONTEN HTML ANDA DARI SINI -->
    <div id="login-container">
        <div class="login-box">
            <h2>Login Peserta Ujian</h2>
            <div class="input-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Masukkan username Anda">
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Masukkan password">
            </div>
            <button id="login-btn">Masuk</button>
            <p id="login-error">Password salah. Coba lagi.</p>
            <a href="/ujian/cara-ikut-tryout-online-gratis" style="text-decoration: none;">
                <button id="cara-btn" type="button">Cara Ikut Try Out</button>
            </a>
        </div>
    </div>

    <header class="header" style="display: none;">
        <h2>Simulasi Ujian</h2>
        <div class="user-info">
            <span id="header-info"></span>
            <button id="logout-btn">Logout</button>
        </div>
    </header>

    <div class="quiz-container" style="display: none;">
        <main class="question-panel">
            <div class="question-header">
                <span id="subtest-title">Subtes</span> | Soal No. <span id="question-number">1</span>
            </div>
            <div class="question-body">
                <p id="question-text">Memuat soal...</p>
                <ul id="options" class="options-list"></ul>
            </div>
            <div class="quiz-actions">
                <button id="prev-btn" class="action-button">Sebelumnya</button>
                <button id="doubtful-btn" class="action-button">Ragu-ragu</button>
                <button id="next-btn" class="action-button">Selanjutnya</button>
            </div>
        </main>
        <aside class="navigation-panel">
            <div class="timer-box">
                Sisa Waktu
                <div id="timer">30:00</div>
            </div>
            <div id="grid-container" class="question-grid-container"></div>
            <div class="quiz-actions" style="justify-content: center;">
                <button id="finish-btn" class="action-button">Selesaikan Ujian</button>
            </div>
        </aside>
    </div>

    <div id="result-page" class="result-container" style="display: none;">
        <div class="result-card overall-summary">
            <div id="status-lulus" class="status"></div>
            <h2>Hasil Akhir Ujian</h2>
            <div id="final-score" class="score">0</div>
            <div id="score-details" class="score-details"></div>
            <div id="submission-status"></div>
        </div>
        <div class="result-card">
            <h3>Tinjauan Jawaban</h3>
            <div id="review-section"></div>
        </div>
        <div style="text-align: center;">
           <button id="restart-btn" class="action-button">Ulangi Ujian</button>
        </div>
    </div>
    
    <div id="confirmation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Selesaikan Ujian?</h2>
            <p>Apakah Anda yakin ingin menyelesaikan dan mengakhiri sesi ujian ini?</p>
            <div class="modal-actions">
                <button id="confirm-no" class="action-button">Batal</button>
                <button id="confirm-yes" class="action-button">Ya, Selesaikan</button>
            </div>
        </div>
    </div>
    <!-- HINGGA AKHIR KONTEN HTML ANDA -->

<script>
// ===================================================================================
// --- KONFIGURASI UJIAN (HANYA UBAH BAGIAN INI UNTUK UJIAN BARU) ---
// ===================================================================================
const EXAM_CONFIG = {
    // 1. Ganti nama kategori ini sesuai nama sheet di Google Sheets (cth: "TWK", "TKP")
    kategori: "SKDCPNS",
    
    // 2. Ganti URL ini dengan URL Web App dari Google Script Anda yang sudah di-deploy ulang.
    scriptURL: 'https://script.google.com/macros/s/AKfycbxNJ9pOsCPSPAPRQKfoq43AwmVMSIScq6AIa33Q0dxnMI-jb1xuxi1aK3bUBFDstinDiQ/exec',
    
    // 3. Ganti link peringkat ini ke halaman peringkat yang sesuai.
    linkPeringkat: "/ujian/ranking-peserta-tryout/",
    
    // 4. Sesuaikan pengaturan ujian jika perlu.
    durasiMenit: 50,
    passingGrade: 55,
    password: "ujian",
    
    // 5. Ganti seluruh isi bank soal di bawah ini dengan soal yang sesuai.
    bankSoal:[
  // --- TES WAWASAN KEBANGSAAN (TWK) - 30 Soal ---

  // Sub-materi: Nasionalisme (6 Soal)
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Sikap dan semangat kebangsaan yang mengutamakan kepentingan bangsa dan negara di atas kepentingan pribadi dan golongan merupakan inti dari...", "options": ["Patriotisme", "Nasionalisme", "Chauvinisme", "Sukuisme"], "answer": "Nasionalisme", "explanation": "Nasionalisme adalah paham kebangsaan yang menempatkan kesetiaan tertinggi individu kepada negara dan bangsa, dengan mengutamakan kepentingan nasional." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Salah satu faktor eksternal yang mendorong lahirnya nasionalisme di Indonesia adalah...", "options": ["Kenangan kejayaan masa lalu kerajaan Sriwijaya dan Majapahit", "Kemenangan Jepang atas Rusia pada tahun 1905", "Lahirnya golongan terpelajar di Indonesia", "Penderitaan rakyat akibat penjajahan"], "answer": "Kemenangan Jepang atas Rusia pada tahun 1905", "explanation": "Kemenangan Jepang atas Rusia membuktikan bahwa bangsa Asia mampu mengalahkan bangsa Eropa, sehingga membangkitkan semangat bangsa-bangsa Asia lain, termasuk Indonesia, untuk melawan penjajahan." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Organisasi pergerakan nasional pertama di Indonesia yang menjadi tonggak awal bangkitnya kesadaran nasional adalah...", "options": ["Sarekat Islam", "Indische Partij", "Budi Utomo", "Perhimpunan Indonesia"], "answer": "Budi Utomo", "explanation": "Budi Utomo, yang didirikan pada 20 Mei 1908, dianggap sebagai organisasi pertama yang membangkitkan kesadaran nasional meskipun pada awalnya fokus pada bidang pendidikan dan kebudayaan Jawa." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Perilaku yang mencerminkan rasa nasionalisme di era globalisasi adalah...", "options": ["Menolak semua produk dan budaya asing yang masuk ke Indonesia", "Menggunakan produk dalam negeri dan mempromosikannya ke luar negeri", "Hanya berteman dengan orang dari suku dan daerah yang sama", "Menganggap budaya Indonesia adalah satu-satunya yang terbaik di dunia"], "answer": "Menggunakan produk dalam negeri dan mempromosikannya ke luar negeri", "explanation": "Nasionalisme di era globalisasi diwujudkan dengan mencintai dan mendukung produk lokal serta memperkenalkannya ke kancah internasional, bukan dengan menutup diri dari dunia luar atau bersikap chauvinistik." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Tujuan utama nasionalisme Indonesia pada masa pergerakan kemerdekaan adalah...", "options": ["Mencapai Indonesia merdeka dan berdaulat", "Meningkatkan kesejahteraan kaum bangsawan", "Menjadikan Indonesia sebagai pemimpin di Asia", "Mengusir semua pedagang asing dari Indonesia"], "answer": "Mencapai Indonesia merdeka dan berdaulat", "explanation": "Seluruh perjuangan organisasi pergerakan nasional pada intinya bertujuan untuk melepaskan diri dari belenggu penjajahan dan mendirikan negara Indonesia yang merdeka dan berdaulat penuh." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Nasionalisme yang berlebihan dan menganggap bangsa sendiri lebih unggul secara ekstrem sehingga merendahkan bangsa lain disebut...", "options": ["Liberalisme", "Patriotisme", "Chauvinisme", "Primordialisme"], "answer": "Chauvinisme", "explanation": "Chauvinisme adalah bentuk nasionalisme sempit yang sangat fanatik dan tidak rasional, yang bertentangan dengan semangat persaudaraan antar bangsa." },

  // Sub-materi: Integritas (6 Soal)
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Seorang Aparatur Sipil Negara (ASN) menolak menerima gratifikasi dalam bentuk apapun yang berkaitan dengan jabatannya. Sikap ini menunjukkan nilai...", "options": ["Akuntabilitas", "Profesionalisme", "Integritas", "Efisiensi"], "answer": "Integritas", "explanation": "Integritas adalah kesesuaian antara perkataan dan perbuatan, serta berpegang teguh pada nilai-nilai moral dan etika. Menolak gratifikasi adalah wujud nyata dari integritas." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Ketika seorang pejabat publik membuat kebijakan yang menguntungkan keluarganya sendiri, ia telah melanggar prinsip...", "options": ["Nepotisme", "Kolusi", "Korupsi", "Konflik Kepentingan"], "answer": "Konflik Kepentingan", "explanation": "Konflik kepentingan terjadi ketika kepentingan pribadi seseorang (misalnya hubungan keluarga) dapat mempengaruhi objektivitas dan profesionalismenya dalam menjalankan tugas publik." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Komitmen untuk bekerja keras demi kepentingan publik dan negara tanpa mengharapkan imbalan pribadi adalah cerminan dari...", "options": ["Dedikasi", "Loyalitas", "Kejujuran", "Tanggung Jawab"], "answer": "Dedikasi", "explanation": "Dedikasi adalah pengorbanan tenaga, pikiran, dan waktu demi keberhasilan suatu usaha atau tujuan mulia, dalam konteks ini adalah pelayanan kepada publik dan negara." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Menjaga kerahasiaan data dan informasi negara yang bersifat rahasia merupakan wujud dari sikap...", "options": ["Disiplin", "Dapat dipercaya", "Transparan", "Adil"], "answer": "Dapat dipercaya", "explanation": "Sikap dapat dipercaya (amanah) dalam konteks ASN mencakup kemampuan untuk memegang teguh rahasia jabatan dan negara yang dipercayakan kepadanya." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Seorang pimpinan yang berani mengakui kesalahan timnya dan bertanggung jawab penuh atas kegagalan tersebut menunjukkan sikap...", "options": ["Ksatria", "Rendah hati", "Jujur", "Adil"], "answer": "Ksatria", "explanation": "Sikap ksatria adalah sikap yang menunjukkan keberanian, kejujuran, dan tanggung jawab, termasuk berani mengakui kesalahan dan tidak melempar tanggung jawab kepada orang lain." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Prinsip 'Say No to Corruption' merupakan kampanye yang bertujuan untuk membangun budaya...", "options": ["Anti-korupsi", "Transparansi", "Akuntabilitas", "Integritas"], "answer": "Integritas", "explanation": "Kampanye anti-korupsi pada dasarnya bertujuan untuk menanamkan dan memperkuat nilai integritas di seluruh lapisan masyarakat dan pemerintahan, karena korupsi adalah musuh utama integritas." },

  // Sub-materi: Bela Negara (5 Soal)
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Kesadaran dan tindakan warga negara yang didasari oleh cinta tanah air, kesadaran berbangsa dan bernegara, serta keyakinan pada Pancasila sebagai ideologi negara disebut...", "options": ["Wawasan Nusantara", "Ketahanan Nasional", "Bela Negara", "Sistem Pertahanan Rakyat Semesta"], "answer": "Bela Negara", "explanation": "Definisi tersebut secara tepat menjelaskan konsep Bela Negara, yang merupakan hak dan kewajiban setiap warga negara untuk ikut serta dalam pembelaan negara." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Berikut ini yang BUKAN merupakan nilai dasar Bela Negara adalah...", "options": ["Cinta tanah air", "Sadar berbangsa dan bernegara", "Setia pada Pancasila", "Mengutamakan kekuatan militer"], "answer": "Mengutamakan kekuatan militer", "explanation": "Bela Negara tidak hanya bersifat militeristik. Nilai dasarnya meliputi cinta tanah air, sadar berbangsa dan bernegara, setia pada Pancasila, rela berkorban, dan kemampuan awal bela negara. Mengutamakan kekuatan militer adalah konsep pertahanan, bukan nilai dasar bela negara bagi setiap warga." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Seorang pelajar yang belajar dengan tekun agar kelak dapat membangun bangsanya merupakan bentuk implementasi bela negara di lingkungan...", "options": ["Masyarakat", "Keluarga", "Sekolah", "Negara"], "answer": "Sekolah", "explanation": "Bagi seorang pelajar, wujud bela negara yang paling utama adalah belajar dengan giat untuk mempersiapkan diri menjadi sumber daya manusia yang unggul bagi kemajuan bangsa." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Membayar pajak tepat waktu merupakan salah satu wujud nyata dari sikap bela negara karena...", "options": ["Pajak digunakan untuk membangun infrastruktur pertahanan", "Membayar pajak adalah kewajiban yang diatur undang-undang", "Pajak adalah sumber utama pendapatan negara untuk pembangunan", "Dengan membayar pajak, warga negara menunjukkan loyalitas"], "answer": "Pajak adalah sumber utama pendapatan negara untuk pembangunan", "explanation": "Dengan membayar pajak, warga negara secara langsung berkontribusi pada kelangsungan hidup dan pembangunan negara, yang merupakan salah satu aspek penting dari bela negara non-fisik." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Ancaman terhadap ideologi negara merupakan salah satu bentuk ancaman dalam bidang...", "options": ["Militer", "Non-militer", "Hibrida", "Politik"], "answer": "Non-militer", "explanation": "Ancaman non-militer adalah ancaman yang tidak menggunakan kekuatan bersenjata tetapi dapat membahayakan kedaulatan negara, kepribadian bangsa, dan keutuhan wilayah. Ancaman ideologi termasuk di dalamnya." },

  // Sub-materi: Pilar Negara (8 Soal)
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Pengakuan dan perlindungan terhadap hak asasi manusia merupakan salah satu penjabaran dari Pancasila, khususnya sila...", "options": ["Ketuhanan Yang Maha Esa", "Kemanusiaan yang adil dan beradab", "Persatuan Indonesia", "Keadilan sosial bagi seluruh rakyat Indonesia"], "answer": "Kemanusiaan yang adil dan beradab", "explanation": "Sila kedua mengandung nilai-nilai kemanusiaan, seperti mengakui persamaan derajat, hak, dan kewajiban asasi setiap manusia tanpa membeda-bedakan." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Pancasila ditetapkan sebagai dasar negara Republik Indonesia pada tanggal...", "options": ["1 Juni 1945", "22 Juni 1945", "17 Agustus 1945", "18 Agustus 1945"], "answer": "18 Agustus 1945", "explanation": "Pancasila secara resmi disahkan sebagai dasar negara oleh Panitia Persiapan Kemerdekaan Indonesia (PPKI) pada sidang tanggal 18 Agustus 1945, sehari setelah proklamasi kemerdekaan." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Menurut UUD 1945, lembaga negara yang memiliki wewenang untuk mengubah dan menetapkan Undang-Undang Dasar adalah...", "options": ["Dewan Perwakilan Rakyat (DPR)", "Majelis Permusyawaratan Rakyat (MPR)", "Presiden", "Mahkamah Konstitusi (MK)"], "answer": "Majelis Permusyawaratan Rakyat (MPR)", "explanation": "Pasal 3 ayat (1) UUD 1945 menyatakan bahwa Majelis Permusyawaratan Rakyat berwenang mengubah dan menetapkan Undang-Undang Dasar." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Amandemen UUD 1945 telah dilakukan sebanyak...", "options": ["Satu kali", "Dua kali", "Tiga kali", "Empat kali"], "answer": "Empat kali", "explanation": "Perubahan (amandemen) terhadap UUD 1945 telah dilakukan sebanyak empat kali secara berturut-turut pada Sidang Umum MPR tahun 1999, 2000, 2001, dan 2002." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Semboyan Bhinneka Tunggal Ika yang berarti 'berbeda-beda tetapi tetap satu' berasal dari kitab...", "options": ["Negarakertagama", "Sutasoma", "Arjunawiwaha", "Pararaton"], "answer": "Sutasoma", "explanation": "Semboyan Bhinneka Tunggal Ika diambil dari kutipan dalam Kakawin Sutasoma, sebuah karya sastra Jawa Kuno karangan Mpu Tantular pada masa Kerajaan Majapahit." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Konsep Wawasan Nusantara memandang Indonesia sebagai satu kesatuan yang utuh dalam bidang...", "options": ["Politik dan Ekonomi", "Sosial dan Budaya", "Pertahanan dan Keamanan", "Semua jawaban benar"], "answer": "Semua jawaban benar", "explanation": "Wawasan Nusantara adalah cara pandang bangsa Indonesia yang memandang diri dan lingkungannya sebagai satu kesatuan ideologi, politik, ekonomi, sosial, budaya, dan pertahanan keamanan (Ipoleksosbudhankam)." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Fungsi Pancasila sebagai 'way of life' atau pandangan hidup bangsa berarti...", "options": ["Pancasila menjadi sumber dari segala sumber hukum", "Pancasila menjadi pedoman dalam bertingkah laku sehari-hari", "Pancasila menjadi dasar dalam mengatur pemerintahan negara", "Pancasila menjadi perjanjian luhur bangsa Indonesia"], "answer": "Pancasila menjadi pedoman dalam bertingkah laku sehari-hari", "explanation": "Sebagai pandangan hidup, Pancasila berfungsi sebagai kristalisasi nilai-nilai luhur yang diyakini kebenarannya dan menjadi pedoman serta acuan bagi bangsa Indonesia dalam kehidupan bermasyarakat, berbangsa, dan bernegara." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Bentuk Negara Kesatuan Republik Indonesia (NKRI) tidak dapat diubah. Ketentuan ini ditegaskan dalam UUD 1945 pasal...", "options": ["Pasal 1 Ayat 1", "Pasal 27 Ayat 3", "Pasal 37 Ayat 5", "Pasal 36A"], "answer": "Pasal 37 Ayat 5", "explanation": "Pasal 37 Ayat (5) UUD 1945 secara khusus menegaskan bahwa 'Khusus mengenai bentuk Negara Kesatuan Republik Indonesia tidak dapat dilakukan perubahan', yang menunjukkan bahwa NKRI adalah harga mati." },

  // Sub-materi: Bahasa Indonesia (5 Soal)
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Penulisan kalimat berikut yang sesuai dengan kaidah PUEBI (Pedoman Umum Ejaan Bahasa Indonesia) adalah...", "options": ["Dia membeli obat di apotik.", "Saya meminta nasehat dari guru saya.", "Aktivitas di pabrik itu sangat padat.", "Jadual keberangkatan kereta telah diumumkan."], "answer": "Aktivitas di pabrik itu sangat padat.", "explanation": "Penulisan yang baku menurut KBBI dan PUEBI adalah 'apotek' (bukan apotik), 'nasihat' (bukan nasehat), dan 'jadwal' (bukan jadual). Kata 'aktivitas' sudah merupakan bentuk baku." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Kalimat yang menggunakan kata berimbuhan 'me-' yang bermakna 'menjadi' adalah...", "options": ["Ibu sedang memasak di dapur.", "Padi di sawah mulai menguning.", "Adik sedang melukis pemandangan.", "Pesawat itu mendarat dengan mulus."], "answer": "Padi di sawah mulai menguning.", "explanation": "Kata 'menguning' pada kalimat tersebut berasal dari kata dasar 'kuning' yang diberi imbuhan 'me-', artinya 'menjadi kuning'." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Ide pokok atau gagasan utama yang mendasari pengembangan sebuah paragraf disebut...", "options": ["Kalimat utama", "Kalimat penjelas", "Gagasan pokok", "Kesimpulan"], "answer": "Gagasan pokok", "explanation": "Gagasan pokok (atau ide pokok) adalah inti dari pembahasan dalam sebuah paragraf, yang kemudian dikembangkan lebih lanjut oleh kalimat-kalimat penjelas." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Manakah di antara kalimat berikut yang merupakan kalimat efektif?", "options": ["Para hadirin dimohon untuk berdiri.", "Bagi siswa yang belum mengumpulkan tugas harap segera melapor.", "Rapat itu membahas tentang kenaikan gaji karyawan.", "Indonesia adalah merupakan negara kepulauan."], "answer": "Rapat itu membahas tentang kenaikan gaji karyawan.", "explanation": "Kalimat A ('para hadirin') dan D ('adalah merupakan') mengandung pemborosan kata. Kalimat B tidak memiliki subjek yang jelas. Kalimat C adalah kalimat yang logis, hemat kata, dan jelas strukturnya." },
  { "subtest": "Tes Wawasan Kebangsaan (TWK)", "question": "Penggunaan tanda koma (,) yang tepat terdapat pada kalimat...", "options": ["Saya ingin membeli buku, pensil dan penghapus.", "Dia tidak datang, karena sakit.", "Surabaya, 20 Mei 2023", "Wah hebat sekali kamu!"], "answer": "Surabaya, 20 Mei 2023", "explanation": "Tanda koma digunakan untuk memisahkan nama tempat dan tanggal surat (pilihan C). Pilihan A seharusnya 'buku, pensil, dan penghapus'. Pilihan B tidak memerlukan koma sebelum 'karena'. Pilihan D seharusnya menggunakan tanda seru (!)." }
],

    // --- Data dinamis ini tidak perlu diubah ---
    judulHalaman: document.title,
    url: window.location.href
};

// ===================================================================================
// --- FUNGSI PENGIRIMAN DATA KE GOOGLE SHEET (DIPERBARUI) ---
// ===================================================================================
async function kirimKeGoogleSheet(data) {
    const statusEl = document.getElementById('submission-status');
    statusEl.textContent = 'Mengirim hasil ujian...';
    
    const formData = new FormData();
    // Menambahkan semua data ke dalam objek FormData.
    formData.append('kategori', data.kategori);
    formData.append('url', data.url);
    formData.append('judulHalaman', data.judulHalaman);
    formData.append('Nama', data.Nama);
    formData.append('JumlahSoal', data.JumlahSoal);
    formData.append('JawabanBenar', data.JawabanBenar);
    formData.append('JawabanSalah', data.JawabanSalah);
    formData.append('TidakDijawab', data.TidakDijawab);
    formData.append('Durasi', data.Durasi);
    formData.append('Nilai', data.Nilai);
    formData.append('StatusKelulusan', data.StatusKelulusan);

    try {
        const response = await fetch(EXAM_CONFIG.scriptURL, {
            method: 'POST',
            body: formData
        });
        
        // Membaca respons sebagai JSON untuk mendapatkan pesan sukses/error dari server
        const result = await response.json();
        
        if (result.result === "success") {
            statusEl.innerHTML = `Hasil ujian berhasil disimpan. <b><a href="${EXAM_CONFIG.linkPeringkat}">Cek Peringkat kamu di sini</a></b>`;
            statusEl.style.color = 'green';
        } else {
            // Menampilkan pesan error yang lebih spesifik dari server
            throw new Error(result.message || 'Terjadi kesalahan dari server.');
        }
    } catch (error) {
        console.error('Error saat mengirim ke Google Sheet:', error);
        statusEl.textContent = `Gagal menyimpan hasil. Coba lagi nanti. Error: ${error.message}`;
        statusEl.style.color = 'red';
    }
}

// ===================================================================================
// --- LOGIKA UTAMA UJIAN (DISESUAIKAN, TIDAK PERLU DIUBAH LAGI) ---
// ===================================================================================
document.addEventListener('DOMContentLoaded', () => {
    // Menggunakan bank soal dari EXAM_CONFIG
    const questions = EXAM_CONFIG.bankSoal;
    let currentQuestionIndex = 0;
    let userAnswers = new Array(questions.length).fill(null);
    let questionStatus = new Array(questions.length).fill('unanswered');
    let timerInterval;
    let startTime;
    let currentUsername = '';

    const loginContainer = document.getElementById('login-container');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');
    const appHeader = document.querySelector('.header');
    const quizContainer = document.querySelector('.quiz-container');
    const resultPage = document.getElementById('result-page');
    const subtestTitleEl = document.getElementById('subtest-title');
    const questionNumberEl = document.getElementById('question-number');
    const questionTextEl = document.getElementById('question-text');
    const optionsEl = document.getElementById('options');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const doubtfulBtn = document.getElementById('doubtful-btn');
    const finishBtn = document.getElementById('finish-btn');
    const timerEl = document.getElementById('timer');
    const restartBtn = document.getElementById('restart-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const headerInfo = document.getElementById('header-info');
    const confirmationModal = document.getElementById('confirmation-modal');
    const confirmYesBtn = document.getElementById('confirm-yes');
    const confirmNoBtn = document.getElementById('confirm-no');
    
    function showLoginPage() {
        loginContainer.style.display = 'block'; // Diubah dari 'flex' agar sesuai skrip asli
        appHeader.style.display = 'none';
        quizContainer.style.display = 'none';
        resultPage.style.display = 'none';
        passwordInput.value = '';
        loginError.style.display = 'none';
    }

    function handleLogin() {
        const password = passwordInput.value;
        const username = usernameInput.value.trim();
        if (username === "") {
            loginError.textContent = "Username tidak boleh kosong.";
            loginError.style.display = 'block';
            return;
        }
        // Menggunakan password dari EXAM_CONFIG
        if (password === EXAM_CONFIG.password) {
            currentUsername = username;
            loginContainer.style.display = 'none';
            appHeader.style.display = 'flex';
            quizContainer.style.display = 'flex';
            resultPage.style.display = 'none';
            headerInfo.textContent = `Peserta: ${currentUsername}`;
            startQuiz();
        } else {
            loginError.textContent = "Password salah. Coba lagi.";
            loginError.style.display = 'block';
        }
    }
    
    function handleLogout() {
        clearInterval(timerInterval);
        showLoginPage();
    }

    function startQuiz() {
        currentQuestionIndex = 0;
        userAnswers.fill(null);
        questionStatus.fill('unanswered');
        quizContainer.style.display = 'flex';
        resultPage.style.display = 'none';
        setupQuestionGrids();
        displayQuestion(currentQuestionIndex);
        // Menggunakan durasi dari EXAM_CONFIG
        startTimer(EXAM_CONFIG.durasiMenit * 60);
        startTime = new Date();
    }

    function setupQuestionGrids() {
        const gridContainer = document.getElementById('grid-container');
        gridContainer.innerHTML = '';
        const subtests = [...new Set(questions.map(q => q.subtest))];
        subtests.forEach(subtest => {
            const group = document.createElement('div');
            group.className = 'subtest-group';
            const title = document.createElement('h3');
            title.textContent = subtest;
            const grid = document.createElement('div');
            grid.className = 'question-grid';
            group.appendChild(title);
            group.appendChild(grid);
            gridContainer.appendChild(group);
            questions.forEach((q, index) => {
                if (q.subtest === subtest) {
                    const button = document.createElement('button');
                    button.className = 'grid-button';
                    button.textContent = index + 1;
                    button.onclick = () => jumpToQuestion(index);
                    grid.appendChild(button);
                }
            });
        });
    }

    function displayQuestion(index) {
        document.querySelector('.grid-button.current')?.classList.remove('current');
        currentQuestionIndex = index;
        const question = questions[index];
        subtestTitleEl.textContent = question.subtest;
        questionNumberEl.textContent = index + 1;
        questionTextEl.innerHTML = question.question;
        optionsEl.innerHTML = '';
        question.options.forEach(option => {
            const li = document.createElement('li');
            const label = document.createElement('label');
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = `option-${index}`;
            radio.value = option;
            if (userAnswers[index] === option) {
                radio.checked = true;
                label.classList.add('selected');
            }
            radio.onchange = () => selectAnswer(index, option, label);
            const span = document.createElement('span');
            span.innerHTML = option; // Menggunakan innerHTML untuk render jika ada format
            label.appendChild(radio);
            label.appendChild(span);
            li.appendChild(label);
            optionsEl.appendChild(li);
        });
        updateNavButtons();
        updateGridButtonStatus(index, true);
    }

    function selectAnswer(index, answer, label) {
        userAnswers[index] = answer;
        document.querySelectorAll(`#options li label`).forEach(l => l.classList.remove('selected'));
        label.classList.add('selected');
        if (questionStatus[index] !== 'doubtful') {
            questionStatus[index] = 'answered';
        }
        updateGridButtonStatus(index);
    }
    
    function updateNavButtons() {
        prevBtn.disabled = currentQuestionIndex === 0;
        nextBtn.disabled = currentQuestionIndex === questions.length - 1;
    }
    
    function updateGridButtonStatus(index, isCurrent = false) {
        const allGridButtons = document.querySelectorAll('.grid-button');
        if (isCurrent) {
            const currentBtn = document.querySelector('.grid-button.current');
            if (currentBtn) currentBtn.classList.remove('current');
        }
        const button = Array.from(allGridButtons).find(btn => parseInt(btn.textContent) === index + 1);
        if (!button) return;
        if(isCurrent) button.classList.add('current');
        button.classList.remove('answered', 'doubtful');
        switch (questionStatus[index]) {
            case 'answered': button.classList.add('answered'); break;
            case 'doubtful': button.classList.add('doubtful'); break;
        }
    }

    function jumpToQuestion(index) {
        displayQuestion(index);
    }

    function startTimer(duration) {
        let timer = duration;
        clearInterval(timerInterval);
        timerEl.parentElement.classList.remove('low-time');
        timerInterval = setInterval(() => {
            let minutes = parseInt(timer / 60, 10);
            let seconds = parseInt(timer % 60, 10);
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            timerEl.textContent = `${minutes}:${seconds}`;
            if (timer < 300 && !timerEl.parentElement.classList.contains('low-time')) { 
                timerEl.parentElement.classList.add('low-time'); 
            }
            if (--timer < 0) {
                clearInterval(timerInterval);
                finishQuiz();
            }
        }, 1000);
    }
    
    function showConfirmation() {
        confirmationModal.style.display = 'flex';
    }

    function formatDuration(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${minutes} menit ${seconds.toString().padStart(2, '0')} detik`;
}


    function finishQuiz() {
        clearInterval(timerInterval);
        confirmationModal.style.display = 'none';
        const endTime = new Date();
        const durationMs = endTime - startTime;
        let correctCount = 0;
        questions.forEach((q, index) => {
            if (userAnswers[index] === q.answer) correctCount++;
        });
        const totalQuestions = questions.length;
        const answeredCount = userAnswers.filter(a => a !== null).length;
        const incorrectCount = answeredCount - correctCount;
        const unansweredCount = totalQuestions - answeredCount;
        const finalScore = totalQuestions > 0 ? parseFloat(((correctCount / totalQuestions) * 100).toFixed(2)) : 0;
        const isPassed = finalScore >= EXAM_CONFIG.passingGrade;
        
        quizContainer.style.display = 'none';
        resultPage.style.display = 'block';
        headerInfo.textContent = `Hasil Ujian: ${currentUsername}`;
        
        const statusEl = document.getElementById('status-lulus');
        statusEl.textContent = isPassed ? 'SELAMAT, ANDA LULUS!' : 'MAAF, ANDA BELUM LULUS';
        statusEl.className = `status ${isPassed ? 'lulus' : 'gagal'}`;
        document.getElementById('final-score').textContent = finalScore;
        document.getElementById('score-details').textContent = `${correctCount} dari ${totalQuestions} soal benar`;
        
        const reviewSection = document.getElementById('review-section');
        reviewSection.innerHTML = '';
        questions.forEach((q, index) => {
            const userAnswer = userAnswers[index];
            const isCorrect = userAnswer === q.answer;
            reviewSection.innerHTML += `
                <div class="review-item">
                    <p><strong>Soal ${index + 1}:</strong> ${q.question}</p>
                    <div class="review-answer user-answer ${isCorrect ? '' : 'is-incorrect'}">Jawaban Anda: ${userAnswer || 'Tidak Dijawab'}</div>
                    ${!isCorrect ? `<div class="review-answer correct-answer">Jawaban Benar: ${q.answer}</div>` : ''}
                    <div class="explanation"><strong>Pembahasan:</strong> ${q.explanation}</div>
                </div>
            `;
        });
        
        const dataForSheet = {
            kategori: EXAM_CONFIG.kategori,
            url: EXAM_CONFIG.url,
            judulHalaman: EXAM_CONFIG.judulHalaman,
            Nama: currentUsername,
            JumlahSoal: totalQuestions,
            JawabanBenar: correctCount,
            JawabanSalah: incorrectCount,
            TidakDijawab: unansweredCount,
            Durasi: formatDuration(durationMs),
            Nilai: finalScore,
            StatusKelulusan: isPassed ? 'Lulus' : 'Tidak Lulus'
        };
        kirimKeGoogleSheet(dataForSheet);
    }

    // Event Listeners
    loginBtn.addEventListener('click', handleLogin);
    passwordInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleLogin(); });
    logoutBtn.addEventListener('click', handleLogout);
    prevBtn.addEventListener('click', () => { if (currentQuestionIndex > 0) displayQuestion(currentQuestionIndex - 1) });
    nextBtn.addEventListener('click', () => { if (currentQuestionIndex < questions.length - 1) displayQuestion(currentQuestionIndex + 1) });
    doubtfulBtn.addEventListener('click', () => {
        const currentStatus = questionStatus[currentQuestionIndex];
        if (currentStatus === 'doubtful') {
            questionStatus[currentQuestionIndex] = userAnswers[currentQuestionIndex] ? 'answered' : 'unanswered';
        } else {
            questionStatus[currentQuestionIndex] = 'doubtful';
        }
        updateGridButtonStatus(currentQuestionIndex);
    });
    finishBtn.addEventListener('click', showConfirmation);
    confirmYesBtn.addEventListener('click', finishQuiz);
    confirmNoBtn.addEventListener('click', () => confirmationModal.style.display = 'none');
    restartBtn.addEventListener('click', handleLogout);

    showLoginPage();
});
</script>
